# å¦å…‹å¤§æ•‘æ´æ’è¡Œæ¦œæŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å¦å…‹å¤§æ•‘æ´æ¸¸æˆçš„æ’è¡Œæ¦œç³»ç»ŸæŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œæ¶µç›–ä»å‰ç«¯åˆ°åç«¯çš„å®Œæ•´è®¾è®¡ä¸å®ç°ã€‚è¯¥æ–¹æ¡ˆé‡‡ç”¨åˆ†é’Ÿçº§å¹‚ç­‰æ€§å¤„ç†ï¼Œé€šè¿‡å•ä¸€æ¥å£å®Œæˆç©å®¶æ•°æ®åŒæ­¥å’Œæ’è¡Œæ¦œæŸ¥è¯¢ï¼Œæœ‰æ•ˆå¹³è¡¡ç”¨æˆ·ä½“éªŒä¸æœåŠ¡å™¨è´Ÿè½½ã€‚

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æµç¨‹
```
ç©å®¶æ“ä½œ â†’ å‰ç«¯æ•°æ®æ”¶é›† â†’ æ¥å£è°ƒç”¨ â†’ åç«¯æ•°æ®å¤„ç† â†’ è¿”å›æ’è¡Œæ¦œæ•°æ®
```

### 2.2 æ ¸å¿ƒç‰¹ç‚¹
- å•ä¸€æ¥å£å¤„ç†æ•°æ®åŒæ­¥ä¸æŸ¥è¯¢
- åˆ†é’Ÿçº§å¹‚ç­‰æ€§æ§åˆ¶
- æœ¬åœ°æ•°æ®ç¼“å­˜ä¼˜åŒ–
- å†›è¡”ç³»ç»Ÿé›†æˆ

## 3. å‰ç«¯å®ç°

### 3.1 æœ¬åœ°æ•°æ®å­˜å‚¨è®¾è®¡

#### 3.1.1 å­˜å‚¨å­—æ®µè¯´æ˜
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| deviceId | string | è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦(UUID) |
| playerName | string | ç©å®¶æ˜µç§° |
| bestRescueCount | number | å†å²æœ€é«˜æ•‘æ´äººæ•° |
| totalSoldiers | number | æ€»æ•‘æ´å£«å…µæ•° |
| playerClickRank | string | ç©å®¶ç‚¹å‡»æ’è¡Œæ¦œæ—¶é—´æˆ³(ç²¾ç¡®åˆ°åˆ†é’Ÿ) |
| cachedRankData | JSON | ç¼“å­˜çš„æ’è¡Œæ¦œæ•°æ® |

#### 3.1.2 æ•°æ®åˆå§‹åŒ–
```typescript
/**
 * åˆå§‹åŒ–ç©å®¶ä¿¡æ¯
 */
private initializePlayerInfo(): void {
    // æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜deviceId
    let deviceId = Laya.LocalStorage.getItem("deviceId");
    if (!deviceId) {
        // ç”Ÿæˆæ–°çš„deviceId (UUID)
        deviceId = this.generateUUID();
        Laya.LocalStorage.setItem("deviceId", deviceId);
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜ç©å®¶æ˜µç§°
    let playerName = Laya.LocalStorage.getItem("playerName");
    if (!playerName) {
        // ç”Ÿæˆé»˜è®¤æ˜µç§°ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æ¯«ç§’å€¼çš„å6ä½
        const timestamp = Date.now().toString();
        const lastSixDigits = timestamp.substring(timestamp.length - 6);
        playerName = `ç©å®¶${lastSixDigits}`;
        Laya.LocalStorage.setItem("playerName", playerName);
    }
}
```

### 3.2 æ’è¡Œæ¦œå¼¹çª—è®¾è®¡

#### 3.2.1 å¼¹çª—UIç»“æ„
```typescript
/**
 * æ˜¾ç¤ºæ’è¡Œæ¦œé¢æ¿
 * @param rankData æ’è¡Œæ¦œæ•°æ®
 */
private showRankPanel(rankData: any): void {
    this.popupPanel.show("æ’è¡Œ", (container: Laya.Sprite) => {
        // åˆ›å»ºTabå®¹å™¨
        const tabContainer = new Laya.Sprite();
        tabContainer.pos(0, 0);
        container.addChild(tabContainer);

        // åˆ›å»ºæ•‘æ´æ¦œTabæŒ‰é’®
        const rescueTab = new Laya.Text();
        rescueTab.text = "æ•‘æ´æ¦œ";
        rescueTab.fontSize = 20;
        rescueTab.color = "#FFD700";
        rescueTab.width = 100;
        rescueTab.height = 40;
        rescueTab.align = "center";
        rescueTab.valign = "middle";
        rescueTab.bgColor = "#4CAF50";
        rescueTab.pos(50, 0);
        rescueTab.name = "rescueTab";
        tabContainer.addChild(rescueTab);

        // åˆ›å»ºå†›è¡”æ¦œTabæŒ‰é’®
        const junxianTab = new Laya.Text();
        junxianTab.text = "å†›è¡”æ¦œ";
        junxianTab.fontSize = 20;
        junxianTab.color = "#333333";
        junxianTab.width = 100;
        junxianTab.height = 40;
        junxianTab.align = "center";
        junxianTab.valign = "middle";
        junxianTab.bgColor = "#DDDDDD";
        junxianTab.pos(200, 0);
        junxianTab.name = "junxianTab";
        tabContainer.addChild(junxianTab);

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const contentContainer = new Laya.Sprite();
        contentContainer.pos(0, 50);
        contentContainer.width = container.width;
        contentContainer.height = container.height - 50;
        container.addChild(contentContainer);

        // æ˜¾ç¤ºé»˜è®¤çš„æ•‘æ´æ¦œ
        this.showRescueList(contentContainer, rankData.rescuelist);

        // æ·»åŠ Tabç‚¹å‡»äº‹ä»¶
        rescueTab.on(Laya.Event.CLICK, this, () => {
            // æ›´æ–°Tabæ ·å¼
            rescueTab.color = "#FFD700";
            rescueTab.bgColor = "#4CAF50";
            junxianTab.color = "#333333";
            junxianTab.bgColor = "#DDDDDD";
            
            // æ¸…ç©ºå†…å®¹å®¹å™¨
            contentContainer.removeChildren();
            
            // æ˜¾ç¤ºæ•‘æ´æ¦œ
            this.showRescueList(contentContainer, rankData.rescuelist);
        });

        junxianTab.on(Laya.Event.CLICK, this, () => {
            // æ›´æ–°Tabæ ·å¼
            junxianTab.color = "#FFD700";
            junxianTab.bgColor = "#4CAF50";
            rescueTab.color = "#333333";
            rescueTab.bgColor = "#DDDDDD";
            
            // æ¸…ç©ºå†…å®¹å®¹å™¨
            contentContainer.removeChildren();
            
            // æ˜¾ç¤ºå†›è¡”æ¦œ
            this.showJunxianList(contentContainer, rankData.junxianlist);
        });
    }, {
        width: 400,
        height: 500
    });
}
```

#### 3.2.2 æ•‘æ´æ¦œåˆ—è¡¨æ˜¾ç¤º
```typescript
/**
 * æ˜¾ç¤ºæ•‘æ´æ¦œåˆ—è¡¨
 * @param container å®¹å™¨
 * @param rescueList æ•‘æ´æ¦œæ•°æ®
 */
private showRescueList(container: Laya.Sprite, rescueList: any[]): void {
    // åˆ›å»ºæ’è¡Œæ¦œæ ‡é¢˜
    const title = new Laya.Text();
    title.text = "æ•‘æ´äººæ•°æ’è¡Œæ¦œ";
    title.fontSize = 18;
    title.color = "#333333";
    title.width = container.width;
    title.align = "center";
    title.y = 10;
    container.addChild(title);

    // åˆ›å»ºæ’è¡Œæ¦œåˆ—è¡¨
    for (let i = 0; i < rescueList.length; i++) {
        const item = rescueList[i];
        
        // åˆ›å»ºæ’è¡Œé¡¹å®¹å™¨
        const itemContainer = new Laya.Sprite();
        itemContainer.width = container.width;
        itemContainer.height = 50;
        itemContainer.y = 40 + i * 60;
        container.addChild(itemContainer);

        // åˆ›å»ºæ’å
        const rankText = new Laya.Text();
        rankText.text = item.rank.toString();
        rankText.fontSize = 20;
        rankText.color = this.getRankColor(item.rank);
        rankText.width = 30;
        rankText.align = "center";
        rankText.y = 15;
        itemContainer.addChild(rankText);

        // åˆ›å»ºå¤´åƒ
        const avatar = new Laya.Image();
        avatar.skin = item.avatar;
        avatar.width = 40;
        avatar.height = 40;
        avatar.x = 40;
        avatar.y = 5;
        itemContainer.addChild(avatar);

        // åˆ›å»ºç©å®¶åç§°
        const nameText = new Laya.Text();
        nameText.text = item.nickName;
        nameText.fontSize = 18;
        nameText.color = "#333333";
        nameText.x = 90;
        nameText.y = 15;
        itemContainer.addChild(nameText);

        // åˆ›å»ºæ•‘æ´äººæ•°
        const rescueCountText = new Laya.Text();
        rescueCountText.text = item.resuceMaxNumber.toString();
        rescueCountText.fontSize = 18;
        rescueCountText.color = "#4CAF50";
        rescueCountText.x = container.width - 100;
        rescueCountText.y = 15;
        itemContainer.addChild(rescueCountText);

        // åˆ›å»º"äºº"å­—
        const renText = new Laya.Text();
        renText.text = "äºº";
        renText.fontSize = 18;
        renText.color = "#4CAF50";
        renText.x = container.width - 40;
        renText.y = 15;
        itemContainer.addChild(renText);
    }
}
```

### 3.3 ç©å®¶æ˜µç§°å¤„ç†

#### 3.3.1 éšæœºæ˜µç§°ç”Ÿæˆ
```typescript
// ç”Ÿæˆé»˜è®¤æ˜µç§°ï¼Œä½¿ç”¨å½“å‰æ—¶é—´æ¯«ç§’å€¼çš„å6ä½
const timestamp = Date.now().toString();
const lastSixDigits = timestamp.substring(timestamp.length - 6);
playerName = `ç©å®¶${lastSixDigits}`;
```

#### 3.3.2 æ˜µç§°ä¿®æ”¹ç®€åŒ–å¤„ç†
```typescript
// åˆ›å»ºç¼–è¾‘æ˜µç§°æŒ‰é’®
const editButton = new Laya.Text();
editButton.text = "ğŸ“";
editButton.fontSize = Math.floor(avatar.height * 0.7);
editButton.color = "#FFFF00";
editButton.x = nameText.x + nameText.width + Math.floor(MARGIN * 0.2);
editButton.y = nameText.y;
editButton.on(Laya.Event.CLICK, this, () => {
    // æ£€æŸ¥ç©å®¶å†›è¡”æ˜¯å¦è¾¾åˆ°è¥é•¿
    const currentRank = Achievement.instance.getCurrentRankInfo_junxian().rank;
    const requiredRank = MilitaryRank.BattalionCommander; // è¥é•¿
    
    // ç®€å•çš„å†›è¡”æ¯”è¾ƒ
    const rankOrder = [
        MilitaryRank.Private, MilitaryRank.SquadLeader, MilitaryRank.PlatoonLeader,
        MilitaryRank.CompanyCommander, MilitaryRank.BattalionCommander, MilitaryRank.RegimentalCommander,
        MilitaryRank.BrigadeCommander, MilitaryRank.DivisionCommander, MilitaryRank.CorpsCommander,
        MilitaryRank.ArmyCommander, MilitaryRank.FieldMarshal, MilitaryRank.GrandMarshal, MilitaryRank.Emperor
    ];
    
    const currentRankIndex = rankOrder.indexOf(currentRank);
    const requiredRankIndex = rankOrder.indexOf(requiredRank);
    
    if (currentRankIndex >= requiredRankIndex) {
        // å†›è¡”è¾¾åˆ°è¦æ±‚ï¼Œå¯ä»¥ä¿®æ”¹æ˜µç§°ï¼ˆæš‚ä¸å®ç°å…·ä½“åŠŸèƒ½ï¼‰
        this.popupPanel.showMessage("å†›è¡”è¾¾åˆ°è¦æ±‚ï¼Œå¯ä»¥ä¿®æ”¹æ˜µç§°ï¼", "æç¤º");
    } else {
        // å†›è¡”æœªè¾¾åˆ°è¦æ±‚
        this.popupPanel.showMessage("å†›è¡”æ™‹å‡è‡³è¥é•¿å¯è‡ªå®šä¹‰æ˜µç§°ï¼", "æç¤º");
    }
});
```

### 3.4 å¹‚ç­‰æ€§å¤„ç†

#### 3.4.1 åˆ†é’Ÿçº§æ§åˆ¶å®ç°
```typescript
/**
 * æ˜¾ç¤ºæ’è¡Œ
 */
private showRank(): void {
    // æ£€æŸ¥å½“å‰åˆ†é’Ÿæ˜¯å¦å·²ç»è·å–è¿‡æ’è¡Œæ¦œæ•°æ®
    const now = new Date();
    const currentMinute = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
    const lastFetchMinute = Laya.LocalStorage.getItem("playerClickRank");
    
    if (lastFetchMinute === currentMinute) {
        // å½“å‰åˆ†é’Ÿå·²ç»è·å–è¿‡æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
        const cachedRankData = Laya.LocalStorage.getItem("cachedRankData");
        if (cachedRankData) {
            try {
                const rankData = JSON.parse(cachedRankData);
                console.log("ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æ’è¡Œæ¦œæ•°æ®");
                this.showRankPanel(rankData);
                return;
            } catch (e) {
                console.error("è§£ææœ¬åœ°ç¼“å­˜æ’è¡Œæ¦œæ•°æ®å¤±è´¥:", e);
            }
        }
    }
    
    // æ›´æ–°playerClickRankä¸ºå½“å‰åˆ†é’Ÿ
    Laya.LocalStorage.setItem("playerClickRank", currentMinute);
    
    // åˆ›å»ºé»˜è®¤çš„æ•‘æ´æ¦œæ•°æ®ï¼ˆå†™æ­»çš„JSONæ•°æ®ï¼‰
    const defaultRankData = {
        "rescuelist": [
            // ... é»˜è®¤æ•°æ® ...
        ],
        "junxianlist": [
            // ... é»˜è®¤æ•°æ® ...
        ]
    };

    // å°è¯•ä»æœåŠ¡å™¨è·å–æ’è¡Œæ¦œæ•°æ®
    this.fetchRankList(defaultRankData);
}
```

### 3.5 æ•°æ®åŒæ­¥æ¥å£è°ƒç”¨

#### 3.5.1 å•ä¸€æ¥å£å¤„ç†
```typescript
/**
 * ä»æœåŠ¡å™¨è·å–æ’è¡Œæ¦œæ•°æ®
 * @param defaultData é»˜è®¤æ•°æ®
 */
private fetchRankList(defaultData: any): void {
    // è·å–ç©å®¶deviceIdå’Œæ˜µç§°
    const deviceId = Laya.LocalStorage.getItem("deviceId") || this.generateUUID();
    const playerName = Laya.LocalStorage.getItem("playerName") || "ç©å®¶";
    
    // è·å–ç©å®¶çš„å†å²æœ€å¤§æ•‘æ´æ•°
    const bestRescueData = Laya.LocalStorage.getItem("bestRescueCount");
    const resuceMaxNumber = bestRescueData ? parseInt(bestRescueData) : 0;
    
    // è·å–ç©å®¶çš„æ€»å£«å…µæ•°ï¼ˆä»æˆå°±ç³»ç»Ÿä¸­è·å–ï¼‰
    const achievementInfo = Achievement.instance.getCurrentRankInfo_junxian();
    const soldiers = achievementInfo.soldiers;
    
    // å‡†å¤‡è¯·æ±‚æ•°æ®
    const requestData = {
        deviceId: deviceId,
        nickName: playerName,
        resuceMaxNumber: resuceMaxNumber,
        soldiers: soldiers
    };

    console.log("å‘é€æ’è¡Œæ¦œè¯·æ±‚æ•°æ®:", requestData); // æ·»åŠ è°ƒè¯•æ—¥å¿—

    // ä½¿ç”¨XMLHttpRequestè·å–æœåŠ¡å™¨æ•°æ®
    const xhr = new Laya.HttpRequest();
    xhr.http.timeout = 10000; // 10ç§’è¶…æ—¶
    
    xhr.once(Laya.Event.COMPLETE, this, (data: string) => {
        try {
            const response = JSON.parse(data);
            console.log("ä»æœåŠ¡å™¨è·å–æ’è¡Œæ¦œåŸå§‹æ•°æ®:", response);
            
            // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
            if (response.success) {
                // è½¬æ¢æ•°æ®æ ¼å¼ä»¥åŒ¹é…å‰ç«¯æœŸæœ›çš„æ ¼å¼
                const rankData = {
                    rescuelist: response.top5ByRescue.map((item: any, index: number) => ({
                        rank: index + 1,
                        nickName: item.nickName,
                        resuceMaxNumber: item.resuceMaxNumber,
                        avatar: item.avatar || "resources/player_log.png"
                    })),
                    junxianlist: response.top5BySoldiers.map((item: any, index: number) => ({
                        rank: index + 1,
                        nickName: item.nickName,
                        soldiers: item.soldiers,
                        avatar: item.avatar || "resources/player_log.png"
                    }))
                };
                
                console.log("è½¬æ¢åçš„æ’è¡Œæ¦œæ•°æ®:", rankData);
                
                // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DDæ ¼å¼
                Laya.LocalStorage.setItem("lastRankFetchDate", today);
                Laya.LocalStorage.setItem("cachedRankData", JSON.stringify(rankData));
                
                // æ˜¾ç¤ºæœåŠ¡å™¨æ•°æ®
                this.showRankPanel(rankData);
            } else {
                console.error("æœåŠ¡å™¨è¿”å›é”™è¯¯:", response.message);
                // æ˜¾ç¤ºé»˜è®¤æ•°æ®
                this.showRankPanel(defaultData);
            }
        } catch (e) {
            console.error("è§£ææœåŠ¡å™¨æ’è¡Œæ¦œæ•°æ®å¤±è´¥:", e);
            // æ˜¾ç¤ºé»˜è®¤æ•°æ®
            this.showRankPanel(defaultData);
        }
    });
    
    xhr.once(Laya.Event.ERROR, this, (data: any) => {
        console.error("ä»æœåŠ¡å™¨è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:", data);
        // æ˜¾ç¤ºé»˜è®¤æ•°æ®
        this.showRankPanel(defaultData);
    });
    
    // å‘é€POSTè¯·æ±‚è·å–æ’è¡Œæ¦œæ•°æ®
    xhr.send(`http://${HOST}/tank_rescue/ranklist`, 
             JSON.stringify(requestData), 
             "post", 
             "text",
             ["Content-Type", "application/json"]);
}
```

## 4. åç«¯å®ç°

### 4.1 æ•°æ®åº“è®¾è®¡

#### 4.1.1 H2æ•°æ®åº“VOè¡¨è®¾è®¡
```java
@Entity
@Table(name = "tankrescue_users")
@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString
public class TankUserVO {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "tankrescueplayer_seq")
    @SequenceGenerator(
            name = "tankrescueplayer_seq",
            sequenceName = "tankrescueplayer_sequence",
            initialValue = 10000,  // è®¾ç½®åˆå§‹å€¼ä¸º10000
            allocationSize = 1    // æ¯æ¬¡é€’å¢1
    )
    private Long id;

    // è®¾å¤‡ id
    @Column(nullable = false, unique = true)
    private String deviceId;

    @Column
    private String nickName;

    // æš‚æ—¶ä¸ç”¨
    @Column(nullable = true, unique = true)
    private String openId;

    @Column
    private Integer resuceMaxNumber;// æœ€é«˜æ•‘æ´æ•°é‡

    @Column
    private Integer soldiers;// æ€»æ•‘æ´æ•°é‡  ä¹Ÿå°±æ˜¯soldiersç©å®¶å£«å…µæ•°é‡

//    private String militaryRank;   // å†›è¡”å°±æ˜¯æ ¹æ® soldiers å†³å®šçš„

    // æš‚æ—¶ä¸ç”¨
    private String avatar;

    @Column(name = "create_time", updatable = false, columnDefinition = "TIMESTAMP DEFAULT CURRENT_TIMESTAMP")
    @CreationTimestamp
    private java.time.LocalDateTime createTime;

}
```

### 4.2 Controlleré€»è¾‘å®ç°

#### 4.2.1 ç»Ÿä¸€æ¥å£å¤„ç†
```java
@RestController
@RequestMapping("/tank_rescue")
@Slf4j
public class TankRescueController {

    @Autowired
    private TankRescueRepository tankRescueRepository;

    /**
     * æ’è¡Œæ¦œæ¥å£ - å¤„ç†ç©å®¶æ•°æ®åŒæ­¥å’Œæ’è¡Œæ¦œæŸ¥è¯¢
     * @param tankUserVO ç©å®¶ä¿¡æ¯
     * @return æ’è¡Œæ¦œæ•°æ®
     */
    @PostMapping("/ranklist")
    public ResponseEntity<?> signIn(@RequestBody TankUserVO tankUserVO) {
        log.info("ç”¨æˆ·{}è¯·æ±‚æ’è¡Œæ¦œæ•°æ®,å®ƒçš„ä¿¡æ¯ä¸º:\n {}", 
                 tankUserVO.getNickName()+"_"+tankUserVO.getDeviceId(), tankUserVO);
        
        // 1. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ–°ç”¨æˆ·åˆ™åˆ›å»º
        TankUserVO existingUser = tankRescueRepository.findByDeviceId(tankUserVO.getDeviceId());
        if(existingUser == null){
            log.info("æ–°ç”¨æˆ·ï¼Œåˆ›å»ºç”¨æˆ·ä¿¡æ¯: {}", tankUserVO);
            tankRescueRepository.save(tankUserVO);
        } else {
            // 2. æ›´æ–°ç°æœ‰ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æœç©å®¶æ•°æ®æ›´å¥½åˆ™æ›´æ–°ï¼‰
            boolean needUpdate = false;
            
            // æ›´æ–°æ˜µç§°ï¼ˆå¦‚æœæä¾›äº†ï¼‰
            if (tankUserVO.getNickName() != null && 
                !tankUserVO.getNickName().equals(existingUser.getNickName())) {
                existingUser.setNickName(tankUserVO.getNickName());
                needUpdate = true;
            }
            
            // æ›´æ–°æœ€é«˜æ•‘æ´æ•°ï¼ˆå¦‚æœæ›´é«˜ï¼‰
            if (tankUserVO.getResuceMaxNumber() != null && 
                tankUserVO.getResuceMaxNumber() > (existingUser.getResuceMaxNumber() != null ? 
                                                   existingUser.getResuceMaxNumber() : 0)) {
                existingUser.setResuceMaxNumber(tankUserVO.getResuceMaxNumber());
                needUpdate = true;
            }
            
            // æ›´æ–°æ€»å£«å…µæ•°ï¼ˆå¦‚æœæ›´é«˜ï¼‰
            if (tankUserVO.getSoldiers() != null && 
                tankUserVO.getSoldiers() > (existingUser.getSoldiers() != null ? 
                                            existingUser.getSoldiers() : 0)) {
                existingUser.setSoldiers(tankUserVO.getSoldiers());
                needUpdate = true;
            }
            
            if (needUpdate) {
                log.info("æ›´æ–°ç”¨æˆ·ä¿¡æ¯: {}", existingUser);
                tankRescueRepository.save(existingUser);
            }
        }
        
        // 3. è·å–æ’è¡Œæ¦œæ•°æ®
        final List<TankUserVO> top5ByRescue = tankRescueRepository.findTop5ByRescue();
        log.info("æŸ¥è¯¢åˆ°çš„æ’è¡Œæ¦œæ•°æ®top5ByRescue: {}" , top5ByRescue);
        final List<TankUserVO> top5BySoldiers = tankRescueRepository.findTop5BySoldiers();
        log.info("æŸ¥è¯¢åˆ°çš„æ’è¡Œæ¦œæ•°æ®top5BySoldiers: {}" , top5BySoldiers);
        
        // 4. æ„é€ å“åº”æ•°æ®
        JSONObject json = new JSONObject();
        json.put("success", true);
        json.put("top5ByRescue", top5ByRescue);
        json.put("top5BySoldiers", top5BySoldiers);
        return ResponseEntity.ok(json);
    }
}
```

### 4.3 Repositoryæ¥å£

#### 4.3.1 æ•°æ®æŸ¥è¯¢æ¥å£
```java
@Repository
public interface TankRescueRepository extends JpaRepository<TankUserVO, Long> {
    
    /**
     * æ ¹æ®è®¾å¤‡IDæŸ¥æ‰¾ç”¨æˆ·
     * @param deviceId è®¾å¤‡ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    TankUserVO findByDeviceId(String deviceId);
    
    /**
     * è·å–æ•‘æ´æ•°æ’è¡Œæ¦œå‰5å
     * @return æ’è¡Œæ¦œåˆ—è¡¨
     */
    @Query("SELECT t FROM TankUserVO t WHERE t.resuceMaxNumber IS NOT NULL ORDER BY t.resuceMaxNumber DESC")
    List<TankUserVO> findTop5ByRescue();
    
    /**
     * è·å–å£«å…µæ•°æ’è¡Œæ¦œå‰5å
     * @return æ’è¡Œæ¦œåˆ—è¡¨
     */
    @Query("SELECT t FROM TankUserVO t WHERE t.soldiers IS NOT NULL ORDER BY t.soldiers DESC")
    List<TankUserVO> findTop5BySoldiers();
}
```

## 5. å†›è¡”ç³»ç»Ÿé›†æˆ

### 5.1 å†›è¡”ç­‰çº§å®šä¹‰
```typescript
// å†›è¡”ç­‰çº§å®šä¹‰
export enum MilitaryRank {
    Private = "åˆ—å…µ",
    SquadLeader = "ç­é•¿",
    PlatoonLeader = "æ’é•¿",
    CompanyCommander = "è¿é•¿",
    BattalionCommander = "è¥é•¿",
    RegimentalCommander = "å›¢é•¿",
    BrigadeCommander = "æ—…é•¿",
    DivisionCommander = "å¸ˆé•¿",
    CorpsCommander = "å†›é•¿",
    ArmyCommander = "é›†å›¢å†›å¸ä»¤",
    FieldMarshal = "å…ƒå¸…",
    GrandMarshal = "å¤§å…ƒå¸…",
    Emperor = "çš‡å¸"
}
```

### 5.2 å†›è¡”åˆ¤å®šé€»è¾‘
```typescript
/**
 * æ ¹æ®å£«å…µæ•°é‡è·å–å†›è¡”
 * @param soldiers å£«å…µæ•°é‡
 * @returns å†›è¡”åç§°
 */
private getMilitaryRankBySoldiers(soldiers: number): string {
    // å†›è¡”é…ç½®ï¼ˆä¸Achievement.tsä¸­çš„é…ç½®ä¸€è‡´ï¼‰
    const rankConfigs = [
        { name: "åˆ—å…µ", requiredSoldiers: 1 },
        { name: "ç­é•¿", requiredSoldiers: 12 },
        { name: "æ’é•¿", requiredSoldiers: 50 },
        { name: "è¿é•¿", requiredSoldiers: 200 },
        { name: "è¥é•¿", requiredSoldiers: 1000 },
        { name: "å›¢é•¿", requiredSoldiers: 3000 },
        { name: "æ—…é•¿", requiredSoldiers: 8000 },
        { name: "å¸ˆé•¿", requiredSoldiers: 15000 },
        { name: "å†›é•¿", requiredSoldiers: 50000 },
        { name: "é›†å›¢å†›å¸ä»¤", requiredSoldiers: 200000 },
        { name: "å…ƒå¸…", requiredSoldiers: 500000 },
        { name: "å¤§å…ƒå¸…", requiredSoldiers: 1000000 },
        { name: "çš‡å¸", requiredSoldiers: 2000000 }
    ];
    
    // ä»é«˜åˆ°ä½æ£€æŸ¥å†›è¡”è¦æ±‚
    for (let i = rankConfigs.length - 1; i >= 0; i--) {
        const config = rankConfigs[i];
        if (soldiers >= config.requiredSoldiers) {
            return config.name;
        }
    }
    
    // é»˜è®¤è¿”å›æœ€ä½å†›è¡”
    return "åˆ—å…µ";
}
```

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 æœ¬åœ°ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨åˆ†é’Ÿçº§æ—¶é—´æˆ³æ§åˆ¶æ¥å£è°ƒç”¨é¢‘ç‡
- æœ¬åœ°å­˜å‚¨æ’è¡Œæ¦œæ•°æ®ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- é»˜è®¤æ•°æ®å…œåº•ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 6.2 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
```sql
-- æ•‘æ´æ•°ç´¢å¼•
CREATE INDEX idx_rescue_max_number ON tankrescue_users(resuceMaxNumber DESC);

-- å£«å…µæ•°ç´¢å¼•
CREATE INDEX idx_soldiers ON tankrescue_users(soldiers DESC);

-- è®¾å¤‡IDå”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_device_id ON tankrescue_users(deviceId);
```

## 7. å®‰å…¨è€ƒè™‘

### 7.1 æ•°æ®æ ¡éªŒ
- è®¾å¤‡IDå”¯ä¸€æ€§æ ¡éªŒ
- æ•°æ®èŒƒå›´åˆç†æ€§æ£€æŸ¥
- é˜²æ­¢æ¶æ„åˆ·æ¦œè¡Œä¸º

### 7.2 æ¥å£é˜²æŠ¤
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- æ•°æ®ç­¾åéªŒè¯ï¼ˆå¯é€‰ï¼‰
- IPé»‘ç™½åå•ï¼ˆå¯é€‰ï¼‰

## 8. æ‰©å±•æ€§è®¾è®¡

### 8.1 å¤šç»´åº¦æ’è¡Œæ¦œ
- æ”¯æŒæŒ‰ä¸åŒç»´åº¦æ’åº
- æ˜“äºæ‰©å±•æ–°çš„æ’è¡Œæ¦œç±»å‹
- ç»Ÿä¸€æ•°æ®æ¥å£è®¾è®¡

### 8.2 å›½é™…åŒ–æ”¯æŒ
- å¤šè¯­è¨€æ˜µç§°å¤„ç†
- æœ¬åœ°åŒ–å†›è¡”åç§°
- æ—¶åŒºé€‚é…

## 9. æµ‹è¯•è¦ç‚¹

### 9.1 åŠŸèƒ½æµ‹è¯•
- æ–°ç”¨æˆ·æ³¨å†Œæµç¨‹
- æ•°æ®åŒæ­¥å‡†ç¡®æ€§
- æ’è¡Œæ¦œå±•ç¤ºæ­£ç¡®æ€§
- å¹‚ç­‰æ€§æ§åˆ¶éªŒè¯

### 9.2 æ€§èƒ½æµ‹è¯•
- æ¥å£å“åº”æ—¶é—´
- å¹¶å‘å¤„ç†èƒ½åŠ›
- æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡
- ç¼“å­˜å‘½ä¸­ç‡

## 10. éƒ¨ç½²å»ºè®®

### 10.1 ç¯å¢ƒé…ç½®
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­£å¼åŸŸå
- æœ¬åœ°è°ƒè¯•æ”¯æŒlocalhosté…ç½®
- æ—¥å¿—çº§åˆ«æŒ‰ç¯å¢ƒåŒºåˆ†

### 10.2 ç›‘æ§å‘Šè­¦
- æ¥å£è°ƒç”¨æˆåŠŸç‡ç›‘æ§
- æ•°æ®åº“æ€§èƒ½ç›‘æ§
- å¼‚å¸¸è¯·æ±‚å‘Šè­¦

---
*æœ¬æ–‡æ¡£ä¸ºå¦å…‹å¤§æ•‘æ´æ¸¸æˆæ’è¡Œæ¦œç³»ç»Ÿçš„æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆï¼Œå¯æ ¹æ®å…·ä½“é¡¹ç›®éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œæ‰©å±•ã€‚*